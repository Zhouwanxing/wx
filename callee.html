<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>WebRTC + MQTT 播放端</title>
    <style>video { width: 45%; border: 1px solid #ccc; }</style>
</head>
<body>
<h3>远程视频</h3>
<video id="remoteVideo" autoplay playsinline></video>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
    const client = mqtt.connect("ws://broker.emqx.io:8083");
    let pc;
    const remoteVideo = document.getElementById("remoteVideo");

    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    client.on("connect", () => {
        console.log("MQTT connected");
        client.subscribe("webrtc/signaling/callee"); // 接收主叫端消息
    });

    client.on("message", async (topic, message) => {
        const data = JSON.parse(message.toString());
        if (!pc) createPeerConnection();

        if (data.type === "offer") {
            await pc.setRemoteDescription(data.sdp);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            client.publish("webrtc/signaling/caller", JSON.stringify({ type: "answer", sdp: answer }));
        } else if (data.type === "candidate") {
            await pc.addIceCandidate(data.candidate);
        }
    });

    function createPeerConnection() {
        pc = new RTCPeerConnection(config);

        pc.ontrack = e => { remoteVideo.srcObject = e.streams[0]; };

        pc.onicecandidate = e => {
            if (e.candidate) {
                client.publish("webrtc/signaling/caller", JSON.stringify({ type: "candidate", candidate: e.candidate }));
            }
        };
    }
</script>
</body>
</html>
