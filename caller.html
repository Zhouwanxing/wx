<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>WebRTC + MQTT 采集端</title>
    <style>video { width: 45%; border: 1px solid #ccc; }</style>
</head>
<body>
<h3>本地摄像头</h3>
<video id="localVideo" autoplay muted playsinline></video>

<h3>远程视频</h3>
<video id="remoteVideo" autoplay playsinline></video>

<button onclick="start()">开始传输</button>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
    const client = mqtt.connect("wss://broker.emqx.io:8084/mqtt");
    let pc;
    let localStream;
    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

    // MQTT 连接
    client.on("connect", () => {
        console.log("MQTT connected");
        client.subscribe("webrtc/signaling/caller");
    });

    // 接收 Callee 消息
    client.on("message", async (topic, message) => {
        const data = JSON.parse(message.toString());
        if (!pc) return;

        if (data.type === "answer") {
            console.log("收到 answer");
            await pc.setRemoteDescription(data.sdp);
        } else if (data.type === "candidate") {
            console.log("收到 candidate");
            await pc.addIceCandidate(data.candidate);
        }
    });

    async function start() {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;

        pc = new RTCPeerConnection(config);

        // 添加本地 track
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        // 接收远端 track
        pc.ontrack = e => {
            remoteVideo.srcObject = e.streams[0];
            console.log("收到远程流");
        };

        // ICE candidate
        pc.onicecandidate = e => {
            if (e.candidate) {
                client.publish("webrtc/signaling/callee", JSON.stringify({ type: "candidate", candidate: e.candidate }));
            }
        };

        // 创建 Offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        client.publish("webrtc/signaling/callee", JSON.stringify({ type: "offer", sdp: offer }));
    }
</script>
</body>
</html>
